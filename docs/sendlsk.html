<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<head>
  <style>
    head {font-size: 10px;}
    hr {border:solid #999 1px; border-bottom:none;}
    ul {margin-left: 0;padding-left: 20px;}
    #testnet, #mainnet {display:inline-block;}
    #mainnet {text-align:right;}
    #contents {padding-left: 10px;font-size: 12px;}
    #contents input {padding: 3px;font-size: 12px;}
    #contents input[type="text"] {width: 30vw;}
    #contents input[type="password"] {width: 80vw;}
    #contents input[type="number"] {width: 30vw;}
    #contents button {padding: 3px 10px;font-size: 12px;margin-left:10px;}
    #sender-info, #recipient-info {margin-bottom: 15px;}
    .title {font-weight:bold;}
    .btn {text-align:center;background-color: #ddf;border-radius: 0.5rem;border: solid 1px #98a;margin-top: 10px;padding: 0.5rem 0;width: calc(80vw + 8px);}
    
    @media screen and (max-width: 800px){
      li {font-size: calc(10px + 1vw);}
      #contents {padding-left: 10px;font-size: calc(10px + 2vw);}
      #contents input[type="text"] {font-size: 18px;width: 60vw;}
      #contents input[type="password"] {font-size: 18px;}
      #contents input[type="number"] {font-size: 18px;width: 30vw;}
      #contents button {padding: 3px;font-size: 18px;margin-left:5px;}
      #message {font-size: 18px;width: 50vw !important;}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2"></script>
  <script src="https://js.lisk.io/lisk-elements-1.0.0.min.js"></script>
  <script>
    var senderAddress = "";
    var recipientAddress = "10242065482765502110L";
    var client = lisk.APIClient.createMainnetAPIClient();
    
    function checksender(arg) {
      var liskaddressElem = document.getElementById('senderaddress');
      senderAddress = liskaddressElem.value.trim();
      if (senderAddress === '') {
        swal({position: 'center',type: 'error',text: 'Sender Address を入力して下さい。'});
        return false;
      }
      if (arg) document.getElementById('sender-info').innerHTML = "Now Loading ..";
      
      var params = {};
      params.address = senderAddress;
      client.accounts.get(params)
      .then(res => {
        console.log(res.data);
        if (res.data.length === 0) {
          swal({position: 'center',type: 'error',text: '存在しないAddressです。'});
          document.getElementById('sender-info').innerHTML = '';
          return;
        }
        
        var accountinfo = res.data[0];
        var html = '<ul>';
        html += '<li>address: ' + accountinfo.address + '</li>'
        html += '<li>balance: <span id="balance">' + (Number(accountinfo.balance) / 100000000) + '</span> LSK</li>'
        html += '</ul>';
        document.getElementById('sender-info').innerHTML = html;
        
      }, function (s) {
        swal({position: 'center',type: 'error',text: s});
        document.getElementById('sender-info').innerHTML = '';
      });
    }
    
    function send() {
      if (senderAddress.length === 0) {
        swal({position: 'center',type: 'error',text: 'Sender の check を実施して下さい。'});
        return;
      }
      
      var amount = document.getElementById('amount').value.trim();
      if (amount.length === 0) {
        swal({position: 'center',type: 'error',text: 'amount を入力して下さい。'});
        return;
      }
      if (Number(amount) < 0.00001) {
        swal({position: 'center',type: 'error',text: 'amount は 0.00001 以上で入力して下さい。'});
        return;
      }

      var balance = document.getElementById('balance').innerText.trim();
      if ((Number(balance)) < Number(amount) + 0.1) {
        swal({position: 'center',type: 'error',text: 'LSKが足りません。'});
        return;
      }
      
      var message = document.getElementById('message').value.trim();
      var tbl = [ 0, 1, 1, 1, 2, 3, 2, 3, 4, 3 ];
      var len = 0;
      for (i = 0; i < message.length; i++) {
        len += tbl [encodeURIComponent(message.charAt(i)).length];
      }
      if (len == 0) {
        swal({position: 'center',type: 'error',text: 'deposit key を入力して下さい。'});
        return;
      }

      var passphraseElem = document.getElementById('passphrase');
      var passphrase2Elem = document.getElementById('passphrase2');
      var passphrase = document.getElementById('passphrase').value.trim();
      var passphrase2 = document.getElementById('passphrase2').value.trim();
      if (passphrase === '') {
        swal({position: 'center',type: 'error',text: 'Passphrase が入力されていません。'});
        return;
      }
      
      if (senderAddress !== lisk.cryptography.getAddressFromPassphrase(passphrase)) {
        swal({position: 'center',type: 'error',text: 'Passphrase が違います。'});
        passphraseElem.value = "";
        return;
      }
      
      var confmsg = '送金します。よろしいですか？';
      confmsg += '<div style="font-size: 12px;">' + senderAddress + ' から</div>';
      confmsg += '<div style="font-size: 12px;">' + recipientAddress + ' へ</div>';
      confmsg += '<div style="font-size: 12px;">' + amount + ' LSK 送金します。</div>';
      confmsg += '<div style="font-size: 10px;">※手数料が別にかかります。</div>';
      swal({position: 'center',
            type: 'warning',
            html: confmsg,
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'OK'
      }).then((result) => {
        if (!result.value) return;
        
        document.getElementById('contents').style="display:none";
        document.getElementById('result').innerHTML = 'Now Loading ..';

        var sendparams = {};
        sendparams.passphrase = passphrase;
        sendparams.amount = amount * 100000000;
        sendparams.recipientId = recipientAddress;
        if (passphrase2.length > 0) sendparams.secondPassphrase = passphrase2;
        if (message.length > 0) sendparams.data = message;
        var transactionstring = lisk.transaction.transfer(sendparams);
        console.log(transactionstring);
        client.transactions.broadcast(transactionstring)
        .then(res => {
          swal({position: 'center',type: 'info',text: '送金しました！'});
          
          var explorerurl = "https://testnet-explorer.lisk.io/tx/" + transactionstring.id;
          document.getElementById('result').innerHTML = '<div>状況は以下で確認してください。</div><br>' +
                                                        '<a href="' + explorerurl + '">Lisk Explorer</a>' +
                                                        '<div style="color:red;font-weight:bold;">Lisk Address: ' + senderAddress + '</div><br>' +
                                                        '<div style="color:red;font-weight:bold;">TransactionID: ' + transactionstring.id + '</div>' +
                                                        '<br>' +
                                                        '<div class="btn" onclick="continuesend()">続けて入金する</div>';
        }, function (s) {
          swal({position: 'center',type: 'error',text: s});
          document.getElementById('result').innerHTML = '';
          document.getElementById('contents').style="";
        });
      });
    }
    
    function continuesend() {
      senderAddress = '';
      document.getElementById('amount').value = '';
      document.getElementById('message').value = '';
      document.getElementById('passphrase').value = '';
      document.getElementById('passphrase2').value = '';
      document.getElementById('sender-info').innerHTML = '';
      document.getElementById('result').innerHTML = '';
      document.getElementById('contents').style="";
    }
  </script>
</head>

<body>
  <div id="contents">
    <div class="title">Sender Account</div>
    <input type="text" id="senderaddress" placeholder="Sednder Address">
    <button onclick="checksender(true)">check</button>
    <div id="sender-info"></div>
    
    <div class="title">Send</div>
    <div><input type="number" id="amount" placeholder="amount"> LSK</div>
    <div><input type="text" id="message" placeholder="deposit key"></div>
    <div><input type="password" id="passphrase" placeholder="Passphrase"></div>
    <div><input type="password" id="passphrase2" placeholder="Second Passphrase"></div>
    <div class="btn" onclick="send()">入金！</div>
  </div>
  <div id="result"></div>
</body>
</html>
